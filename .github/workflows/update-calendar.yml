name: Test and Deploy Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  run-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
        
    - name: Debug Environment
      run: |
        echo "🔍 Checking initial setup..."
        echo "Current directory: $PWD"
        echo "Directory contents:"
        ls -la
        echo "Python version:"
        python --version
        pip --version
        
    - name: Install dependencies
      run: |
        echo "📦 Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "Installed packages:"
        pip freeze
      
    - name: Test Python Imports
      run: |
        echo "🧪 Testing Python imports..."
        python -c "
        try:
            import requests
            print('✅ requests import successful')
            import bs4
            print('✅ beautifulsoup4 import successful')
            import icalendar
            print('✅ icalendar import successful')
            import pytz
            print('✅ pytz import successful')
        except Exception as e:
            print(f'❌ Import error: {str(e)}')
            exit(1)
        "
        
    - name: Create Output Directory
      run: |
        echo "📁 Creating output directory..."
        mkdir -p _site
        echo "Directory created at: $PWD/_site"
        ls -la _site
        
    - name: Run Scraper with Debug
      run: |
        echo "🚀 Running scraper with debug output..."
        python -u scraper.py  # -u for unbuffered output
        
    - name: Check Script Output
      if: always()  # Run even if previous step failed
      run: |
        echo "📋 Checking script results..."
        echo "Current directory structure:"
        tree .
        echo "Content of _site directory:"
        ls -la _site/ || echo "❌ _site directory not found"
        if [ -f "_site/index.html" ]; then
          echo "📄 Found index.html - first 20 lines:"
          head -n 20 _site/index.html
        else
          echo "❌ index.html not found"
        fi
        if [ -f "_site/nyc-screenings.ics" ]; then
          echo "📅 Found nyc-screenings.ics - first 20 lines:"
          head -n 20 _site/nyc-screenings.ics
        else
          echo "❌ nyc-screenings.ics not found"
        fi
        
    - name: Archive Logs
      if: always()  # Run even if previous steps failed
      uses: actions/upload-artifact@v3
      with:
        name: debug-logs
        path: |
          ./_site/
          ./scraper.py
          ./requirements.txt
