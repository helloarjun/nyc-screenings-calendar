name: Test and Deploy Calendar

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'

jobs:
  run-script:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Setup Python
      uses: actions/setup-python@v3
      with:
        python-version: '3.10'
        
    - name: Debug Environment
      run: |
        echo "ğŸ” Checking initial setup..."
        echo "Current directory: $PWD"
        echo "Directory contents:"
        ls -la
        echo "Python version:"
        python --version
        pip --version
        
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "Installed packages:"
        pip freeze
      
    - name: Test Python Imports
      run: |
        echo "ğŸ§ª Testing Python imports..."
        python -c "
        try:
            import requests
            print('âœ… requests import successful')
            import bs4
            print('âœ… beautifulsoup4 import successful')
            import icalendar
            print('âœ… icalendar import successful')
            import pytz
            print('âœ… pytz import successful')
        except Exception as e:
            print(f'âŒ Import error: {str(e)}')
            exit(1)
        "
        
    - name: Create Output Directory
      run: |
        echo "ğŸ“ Creating output directory..."
        mkdir -p _site
        echo "Directory created at: $PWD/_site"
        ls -la _site
        
    - name: Run Scraper with Debug
      run: |
        echo "ğŸš€ Running scraper with debug output..."
        python -u scraper.py  # -u for unbuffered output
        
    - name: Check Script Output
      if: always()  # Run even if previous step failed
      run: |
        echo "ğŸ“‹ Checking script results..."
        echo "Current directory structure:"
        tree .
        echo "Content of _site directory:"
        ls -la _site/ || echo "âŒ _site directory not found"
        if [ -f "_site/index.html" ]; then
          echo "ğŸ“„ Found index.html - first 20 lines:"
          head -n 20 _site/index.html
        else
          echo "âŒ index.html not found"
        fi
        if [ -f "_site/nyc-screenings.ics" ]; then
          echo "ğŸ“… Found nyc-screenings.ics - first 20 lines:"
          head -n 20 _site/nyc-screenings.ics
        else
          echo "âŒ nyc-screenings.ics not found"
        fi
        
    - name: Archive Logs
      if: always()  # Run even if previous steps failed
      uses: actions/upload-artifact@v3
      with:
        name: debug-logs
        path: |
          ./_site/
          ./scraper.py
          ./requirements.txt
